<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر ودمج الجداول</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Styling for Single-File Deployment and performance */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
        }
        #data-area {
            overflow: auto;
            max-height: 70vh;
            border-radius: 0.5rem;
            min-height: 300px; /* Ensure space even when empty */
        }
        #dataTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            /* تم إزالة table-layout: fixed للسماح للأعمدة بالتوسع حسب المحتوى */
        }
        #dataTable th, #dataTable td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: right;
            /* إزالة overflow و text-overflow من هنا */
        }
        #dataTable th {
            background-color: #1f2937;
            color: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap; /* إبقاء العناوين في سطر واحد */
            min-width: 100px; /* ضمان حد أدنى للعرض */
        }
        #dataTable td {
            background-color: #ffffff;
            white-space: normal; /* السماح لمحتوى البيانات بالالتفاف */
            min-width: 80px; 
            word-wrap: break-word; /* التأكد من كسر الكلمات الطويلة جداً */
        }
        #dataTable td:focus {
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
            background-color: #e0f2fe;
            white-space: normal;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
    </style>
    
    <!-- Firebase SDKs for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let db;
        let auth;
        let userId;

        window.firebaseReady = false;
        window.db = null;
        window.userId = null;
        window.appId = appId;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db;

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    window.userId = userId;
                    window.firebaseReady = true;
                } else {
                    try {
                        let userCredential;
                        if (initialAuthToken) {
                            userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            userCredential = await signInAnonymously(auth);
                        }
                        userId = userCredential.user.uid;
                        window.userId = userId;
                        window.firebaseReady = true;
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        if (initialAuthToken) {
                             signInAnonymously(auth).then(uc => {
                                window.userId = uc.user.uid;
                                window.firebaseReady = true;
                             }).catch(e => console.error("Final Auth Fail:", e));
                        }
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Failed:", error);
        }
    </script>
    <!-- SheetJS CDN for high-performance file reading/writing (XLSX, CSV) -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-4 text-center">محرر ودمج الجداول</h1>
        <p class="text-center text-gray-600 mb-8">افتح ملفًا واحدًا للتعديل، أو اختر عدة ملفات لدمجها في جدول واحد.</p>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
            <div class="bg-white p-6 rounded-lg shadow-lg flex items-center space-x-3 text-lg font-semibold text-gray-700">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>جاري المعالجة...</span>
            </div>
        </div>

        <!-- Hidden File Input -->
        <input type="file" id="file-input" accept=".csv, .xlsx, .xls" multiple class="hidden" onchange="handleFileSelect(event)">

        <!-- Control Panel (Buttons) -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <button onclick="document.getElementById('file-input').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-2 sm:px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 text-sm md:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rtl:ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                <span>فتح ملف</span>
            </button>

            <button id="merge-btn" onclick="mergeFiles()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-2 sm:px-4 rounded-lg transition duration-300 shadow-lg disabled:opacity-50 flex items-center justify-center space-x-2 text-sm md:text-base" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rtl:ml-2" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" /><path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" /></svg>
                <span>دمج الملفات</span>
            </button>
            
            <button onclick="saveDataToFirestore()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-2 sm:px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 text-sm md:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rtl:ml-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.657 5.657l-4.95 4.95a1 1 0 000 1.414l3.536 3.536a1 1 0 001.414 0l4.95-4.95-3.536-3.536-2.828 2.828z" /></svg>
                <span>حفظ الجلسة</span>
            </button>

            <button onclick="loadDataFromFirestore()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-2 sm:px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 text-sm md:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rtl:ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.564 1 1 0 01-1.357.625 5.002 5.002 0 00-8.91 0 1 1 0 01-1.357-.625A7.002 7.002 0 014 5.101V3a1 1 0 011-1zm10 12a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1z" clip-rule="evenodd" /><path d="M11 13a1 1 0 100 2h2a1 1 0 100-2h-2z" /></svg>
                <span>تحميل المحفوظة</span>
            </button>

            <button onclick="showModal('download-modal')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-2 sm:px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 text-sm md:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rtl:ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3-2a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M12 9a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zM9 9a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1zM6 9a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span>تنزيل الملف</span>
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Data Display & Options (3/4 Width on large screens) -->
            <div class="lg:col-span-3">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">منطقة عرض البيانات</h2>
                <div id="data-area" class="bg-gray-50 border border-gray-300 rounded-lg shadow-inner overflow-x-auto">
                    <table id="dataTable" class="min-w-full">
                        <tbody id="dataTableBody">
                            <tr><td colspan="100" class="text-center py-10 text-gray-500">اختر ملفًا، حمّل جلسة، أو أنشئ جدولاً جديداً لبدء التعديل...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Edit Options Bar -->
                <div class="mt-6 p-4 bg-gray-100 rounded-lg shadow-inner flex flex-wrap justify-center gap-3">
                    <button onclick="createNewTablePreconfirm()" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        إنشاء جدول جديد
                    </button>
                    <button onclick="addRow()" class="text-sm bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        إضافة سطر جديد
                    </button>
                    <button onclick="showColumnManager()" class="text-sm bg-cyan-500 hover:bg-cyan-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        إدارة الأعمدة
                    </button>
                    <button onclick="showRemoveDuplicatesModal()" class="text-sm bg-pink-500 hover:bg-pink-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        إزالة التكرارات
                    </button>
                    <button onclick="showModal('delete-match-modal')" class="text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        حذف السطور المطابقة
                    </button>
                    <button onclick="showModal('keep-match-modal')" class="text-sm bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        الإبقاء على المطابقة فقط
                    </button>
                    <button onclick="clearTablePreconfirm()" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-md transition duration-200 shadow-md">
                        مسح الجدول بالكامل
                    </button>
                </div>
            </div>

            <!-- Change Report (1/4 Width on large screens) -->
            <div class="lg:col-span-1">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">تقرير التغييرات</h3>
                <div class="bg-gray-100 p-6 rounded-lg shadow-md space-y-3">
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">السطور الأصلية</span>
                        <span id="report-original" class="font-bold text-gray-800">0</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">سطور مضافة</span>
                        <span id="report-added" class="font-bold text-green-600">0</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">سطور محذوفة</span>
                        <span id="report-deleted" class="font-bold text-red-600">0</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-300">
                        <span class="text-lg font-semibold text-gray-700">الإجمالي المتبقي</span>
                        <span id="report-total" class="text-xl font-bold text-blue-600">0</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals Section (Same as previous version, but now all linked functions are robust) -->
    
    <!-- Modal 1: Create Table -->
    <div id="create-table-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">إنشاء جدول جديد</h3>
            <p class="text-red-500 mb-4">تحذير: هذا سيؤدي إلى مسح أي بيانات غير محفوظة حاليًا.</p>
            <div class="space-y-4">
                <div>
                    <label for="new-cols" class="block text-sm font-medium text-gray-700 mb-1">عدد الأعمدة:</label>
                    <input type="number" id="new-cols" value="4" min="1" class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="new-rows" class="block text-sm font-medium text-gray-700 mb-1">عدد السطور:</label>
                    <input type="number" id="new-rows" value="5" min="1" class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3 rtl:space-x-reverse">
                <button onclick="hideModal('create-table-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                    إلغاء
                </button>
                <button onclick="createNewTable()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    إنشاء ومسح
                </button>
            </div>
        </div>
    </div>

    <!-- Modal 2: Delete Matching Rows -->
    <div id="delete-match-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">حذف السطور المطابقة</h3>
            <p class="text-gray-600 mb-4">أدخل كلمة أو عبارة مفتاحية. سيتم حذف أي سطر يحتوي عليها.</p>
            <div>
                <label for="delete-keyword" class="block text-sm font-medium text-gray-700 mb-1">الكلمة/العبارة المفتاحية:</label>
                <input type="text" id="delete-keyword" placeholder="النص المراد حذفه..." class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-red-500 focus:border-red-500">
            </div>
            <div class="mt-6 flex justify-end space-x-3 rtl:space-x-reverse">
                <button onclick="hideModal('delete-match-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                    إلغاء
                </button>
                <button onclick="filterTable('delete')" class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    تأكيد الحذف
                </button>
            </div>
        </div>
    </div>

    <!-- Modal 3: Keep Matching Rows Only -->
    <div id="keep-match-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">الإبقاء على السطور المطابقة فقط</h3>
            <p class="text-gray-600 mb-4">أدخل كلمة أو عبارة مفتاحية. سيتم حذف كل السطور *التي لا* تحتوي عليها.</p>
            <div>
                <label for="keep-keyword" class="block text-sm font-medium text-gray-700 mb-1">الكلمة/العبارة المفتاحية:</label>
                <input type="text" id="keep-keyword" placeholder="النص المراد الإبقاء عليه..." class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-purple-500 focus:border-purple-500">
            </div>
            <div class="mt-6 flex justify-end space-x-3 rtl:space-x-reverse">
                <button onclick="hideModal('keep-match-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                    إلغاء
                </button>
                <button onclick="filterTable('keep')" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    تأكيد الإبقاء
                </button>
            </div>
        </div>
    </div>

    <!-- Modal 4: Download Options -->
    <div id="download-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">حفظ وتنزيل الملف</h3>

            <!-- Filename Input -->
            <div class="mb-4">
                <label for="download-filename" class="block text-sm font-medium text-gray-700 mb-1">اسم الملف:</label>
                <input type="text" id="download-filename" value="جدول_معدل" class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-green-500 focus:border-green-500">
            </div>

            <!-- Format Selection -->
            <div class="space-y-3">
                <label class="flex items-center space-x-3 rtl:space-x-reverse">
                    <input type="radio" name="file-format" value="xlsx" checked class="form-radio h-4 w-4 text-green-600">
                    <span class="text-gray-700">Excel (.xlsx) - أفضل خيار</span>
                </label>
                <label class="flex items-center space-x-3 rtl:space-x-reverse">
                    <input type="radio" name="file-format" value="csv" class="form-radio h-4 w-4 text-green-600">
                    <span class="text-gray-700">Comma Separated Values (.csv) - نص عادي</span>
                </label>
                <label class="flex items-center space-x-3 rtl:space-x-reverse">
                    <input type="radio" name="file-format" value="json" class="form-radio h-4 w-4 text-green-600">
                    <span class="text-gray-700">JSON (.json) - للاستخدام البرمجي</span>
                </label>
            </div>

            <div class="mt-6 flex justify-end space-x-3 rtl:space-x-reverse">
                <button onclick="hideModal('download-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                    إلغاء
                </button>
                <button onclick="downloadFile()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    بدء التنزيل
                </button>
            </div>
        </div>
    </div>

    <!-- Modal 5: Manage Columns -->
    <div id="manage-columns-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">إدارة الأعمدة</h3>
            <p class="text-gray-600 mb-4">أضف أو احذف الأعمدة من الجدول.</p>
            <div class="space-y-4">
                <div>
                    <button onclick="performAddColumn()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                        إضافة عمود جديد
                    </button>
                </div>
                <div id="remove-col-container">
                    <label for="remove-col-select" class="block text-sm font-medium text-gray-700 mb-1">اختر عموداً للحذف:</label>
                    <select id="remove-col-select" class="w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-red-500 focus:border-red-500"></select>
                    <button onclick="performRemoveColumn()" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-md transition duration-200 disabled:opacity-50" id="remove-col-btn">
                        حذف العمود المحدد
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="hideModal('manage-columns-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Modal 6: Remove Duplicates -->
    <div id="remove-duplicates-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4 text-gray-800">إزالة السطور المكررة</h3>
            <p class="text-gray-600 mb-4">اختر طريقة تحديد التكرار:</p>
            <div class="space-y-4">
                <label class="flex items-center space-x-3 rtl:space-x-reverse">
                    <input type="radio" name="duplicate-mode" value="all" checked class="form-radio h-4 w-4 text-pink-600">
                    <span class="text-gray-700">تكرار السطر بالكامل (كل الأعمدة)</span>
                </label>
                <label class="block">
                    <input type="radio" name="duplicate-mode" value="column" class="form-radio h-4 w-4 text-pink-600 rtl:ml-2">
                    <span class="text-gray-700">تكرار بناءً على عمود محدد:</span>
                    <select id="duplicate-col-select" class="w-full mt-2 border-gray-300 rounded-md shadow-sm p-2 border focus:ring-pink-500 focus:border-pink-500 disabled:bg-gray-100" disabled></select>
                </label>
            </div>
            <div class="mt-6 flex justify-end space-x-3 rtl:space-x-reverse">
                <button onclick="hideModal('remove-duplicates-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200">
                    إلغاء
                </button>
                <button onclick="removeDuplicates()" class="bg-pink-500 hover:bg-pink-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    تأكيد الإزالة
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box (Custom Confirmation / Alert) -->
    <div id="message-box" class="modal-overlay">
        <div class="modal-content">
            <h3 id="message-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="message-text" class="text-gray-600 mb-4"></p>
            <div class="mt-6 flex justify-end">
                <button onclick="hideModal('message-box')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    إغلاق
                </button>
            </div>
        </div>
    </div>


    <script>
        // JavaScript Logic - Global Scope for high performance
        
        let currentData = [];
        let originalData = [];
        let loadedFiles = [];
        let fileBuffers = [];
        
        // Helper function for deep cloning an array (used for originalData copy)
        const deepClone = (arr) => JSON.parse(JSON.stringify(arr));

        // --- UI Utility Functions ---

        function showModal(id, title = '', text = '') {
            const modal = document.getElementById(id);
            if (modal) {
                if (id === 'message-box') {
                    document.getElementById('message-title').textContent = title;
                    document.getElementById('message-text').textContent = text;
                }
                modal.style.display = 'flex';
            }
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'none';
                // Reset custom buttons if the message box is closed
                if (id === 'message-box') {
                    const footer = modal.querySelector('.mt-6.flex.justify-end');
                    footer.innerHTML = `<button onclick="hideModal('message-box')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">إغلاق</button>`;
                }
            }
        }

        function toggleLoading(show) {
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
        }

        function updateChangeReport() {
            const originalCount = originalData.length > 0 ? originalData.length - 1 : 0;
            const currentCount = currentData.length > 0 ? currentData.length - 1 : 0;

            const added = Math.max(0, currentCount - originalCount);
            const deleted = Math.max(0, originalCount - currentCount);

            document.getElementById('report-original').textContent = originalCount;
            document.getElementById('report-added').textContent = added;
            document.getElementById('report-deleted').textContent = deleted;
            document.getElementById('report-total').textContent = currentCount;
        }
        
        /**
         * Renders the table using efficient DOM manipulation for responsiveness.
         */
        function renderTable() {
            const tableBody = document.getElementById('dataTableBody');
            
            // Minimal update check
            if (currentData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-10 text-gray-500">اختر ملفًا، حمّل جلسة، أو أنشئ جدولاً جديداً لبدء التعديل...</td></tr>';
                document.getElementById('merge-btn').disabled = fileBuffers.length < 2;
                updateChangeReport();
                return;
            }

            const colCount = currentData[0].length;
            const fragment = document.createDocumentFragment();

            // 1. Create Header Row (stuck to table head if table element was used, but sticking to tbody here)
            const headerRow = document.createElement('tr');
            headerRow.classList.add('bg-gray-800', 'text-white', 'sticky', 'top-0');
            currentData[0].forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = String(headerText || `عمود ${index + 1}`).trim();
                headerRow.appendChild(th);
            });
            fragment.appendChild(headerRow);

            // 2. Create Data Rows (start from index 1)
            for (let i = 1; i < currentData.length; i++) {
                const dataRow = document.createElement('tr');
                for (let j = 0; j < colCount; j++) {
                    const cellData = currentData[i][j] !== undefined ? currentData[i][j] : '';
                    const td = document.createElement('td');
                    td.textContent = String(cellData);
                    td.contentEditable = true;
                    td.classList.add('p-3', 'focus:ring-2', 'focus:ring-blue-500', 'focus:bg-blue-50', 'transition', 'duration-100');
                    td.dataset.rowIndex = i;
                    td.dataset.colIndex = j;
                    td.oninput = (event) => updateDataCell(event.target, i, j);
                    dataRow.appendChild(td);
                }
                fragment.appendChild(dataRow);
            }
            
            // Replace old content with the new fragment in a single DOM operation
            tableBody.innerHTML = '';
            tableBody.appendChild(fragment);

            document.getElementById('merge-btn').disabled = fileBuffers.length < 2;
            updateChangeReport();
        }

        function updateDataCell(cell, row, col) {
            // Convert to string before assignment for consistency
            const newValue = String(cell.textContent);
            if (currentData[row] && currentData[row][col] !== undefined) {
                currentData[row][col] = newValue;
            } else if (currentData[row]) {
                 // Defensive code: handle case where row array is shorter than col index
                const currentCols = currentData[0].length;
                 while(currentData[row].length < currentCols) {
                     currentData[row].push('');
                 }
                currentData[row][col] = newValue;
            }
        }

        // --- Core Application Logic (File I/O and Merge) ---

        /**
         * Handles file selection and parsing asynchronously.
         */
        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            toggleLoading(true);
            
            loadedFiles = [];
            fileBuffers = [];
            
            if (files.length === 1) {
                currentData = [];
                originalData = [];
            }

            const totalFiles = files.length;
            let promises = [];

            Array.from(files).forEach((file) => {
                promises.push(new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const arrayBuffer = e.target.result;
                            fileBuffers.push(arrayBuffer);

                            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                            
                            resolve({ filename: file.name, data: sheetData });

                        } catch (error) {
                            console.error(`Error processing file ${file.name}:`, error);
                            // Resolve with null to skip this file
                            resolve(null); 
                        }
                    };

                    reader.onerror = () => resolve(null); // Resolve with null on read error
                    reader.readAsArrayBuffer(file);
                }));
            });

            // Wait for all files to be processed
            const results = (await Promise.all(promises)).filter(result => result !== null);
            loadedFiles = results;

            toggleLoading(false);

            if (loadedFiles.length === 1) {
                currentData = loadedFiles[0].data;
                originalData = deepClone(currentData);
                renderTable();
            } else if (loadedFiles.length > 1) {
                document.getElementById('merge-btn').disabled = false;
                showModal('message-box', 'ملفات متعددة جاهزة', `تم تحميل ${loadedFiles.length} ملفات بنجاح. اضغط على "دمج الملفات المحددة" لتوحيدها.`);
            } else {
                 showModal('message-box', 'فشل التحميل', 'لم يتم تحميل أي ملفات بنجاح. تأكد من أن التنسيق صحيح (.xlsx, .csv).');
            }

            event.target.value = '';
        }

        /**
         * Merges all loaded file data, padding/trimming rows to match the main header.
         */
        function mergeFiles() {
            if (loadedFiles.length < 2) {
                showModal('message-box', 'فشل الدمج', 'الرجاء اختيار ملفين على الأقل للدمج.');
                return;
            }

            toggleLoading(true);
            let mergedData = [];
            
            if (loadedFiles[0].data.length === 0) {
                 toggleLoading(false);
                 showModal('message-box', 'خطأ في الملف الأول', 'الملف الأول فارغ ولا يمكن استخدامه لتحديد العناوين.');
                 return;
            }
            
            const headers = loadedFiles[0].data[0];
            const headerLength = headers.length;
            mergedData.push(headers);

            // Use Array.prototype.flatMap for efficient, single-pass merging
            const dataRows = loadedFiles.flatMap(file => {
                // Ensure file data exists and has data rows
                if (file.data.length <= 1) return []; 
                
                const rowsToMerge = file.data.slice(1); // Exclude header

                return rowsToMerge.map(row => {
                    // Normalize row length to match header length
                    if (row.length < headerLength) {
                        return row.concat(Array(headerLength - row.length).fill(''));
                    } else if (row.length > headerLength) {
                        return row.slice(0, headerLength);
                    }
                    return row;
                });
            });

            currentData = mergedData.concat(dataRows);
            originalData = deepClone(currentData);
            loadedFiles = [];
            fileBuffers = [];
            document.getElementById('merge-btn').disabled = true;

            // Use setTimeout to ensure UI remains responsive during the merge result display
            setTimeout(() => {
                renderTable();
                toggleLoading(false);
                showModal('message-box', 'تم الدمج بنجاح', `تم دمج جميع الملفات في جدول واحد يضم ${currentData.length - 1} سطر بيانات.`);
            }, 0);
        }

        // --- Firestore Persistence Functions (Async and Robust) ---

        async function saveDataToFirestore() {
            if (!window.firebaseReady || !window.userId) {
                showModal('message-box', 'خطأ في المصادقة', 'خدمات الحفظ غير جاهزة. يرجى الانتظار قليلاً أو محاولة إعادة تحميل الصفحة.');
                return;
            }
            if (currentData.length === 0) {
                showModal('message-box', 'لا توجد بيانات', 'الجدول الحالي فارغ. لا يمكن حفظ جلسة فارغة.');
                return;
            }

            toggleLoading(true);
            try {
                // Import Firestore functions dynamically (needed as this is called from the global scope)
                const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const SHEET_PATH = `artifacts/${window.appId}/users/${window.userId}/sheets/current_sheet`;

                // Use deepClone for safe serialization
                const dataToSave = JSON.stringify({
                    data: deepClone(currentData),
                    originalData: deepClone(originalData),
                    timestamp: new Date().toISOString()
                });
                
                const docRef = doc(window.db, SHEET_PATH);
                await setDoc(docRef, { 
                    content: dataToSave,
                    ownerId: window.userId
                });

                toggleLoading(false);
                showModal('message-box', 'تم الحفظ بنجاح', 'تم حفظ الجدول الحالي في مساحة التخزين السحابي الخاصة بك.');

            } catch (error) {
                console.error("Firestore Save Error:", error);
                toggleLoading(false);
                showModal('message-box', 'فشل الحفظ', `حدث خطأ أثناء محاولة حفظ البيانات: ${error.message}`);
            }
        }

        async function loadDataFromFirestore() {
            if (!window.firebaseReady || !window.userId) {
                showModal('message-box', 'خطأ في المصادقة', 'خدمات التحميل غير جاهزة. يرجى الانتظار قليلاً أو محاولة إعادة تحميل الصفحة.');
                return;
            }

            toggleLoading(true);
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const SHEET_PATH = `artifacts/${window.appId}/users/${window.userId}/sheets/current_sheet`;

                const docRef = doc(window.db, SHEET_PATH);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const savedData = JSON.parse(docSnap.data().content);
                    currentData = savedData.data || [];
                    originalData = savedData.originalData || [];

                    loadedFiles = [];
                    fileBuffers = [];
                    document.getElementById('merge-btn').disabled = true;

                    renderTable();
                    toggleLoading(false);
                    showModal('message-box', 'تم التحميل بنجاح', 'تم تحميل آخر جلسة عمل محفوظة.');
                } else {
                    toggleLoading(false);
                    showModal('message-box', 'لا توجد بيانات', 'لم يتم العثور على أي جلسة عمل محفوظة لهذا المستخدم.');
                }

            } catch (error) {
                console.error("Firestore Load Error:", error);
                toggleLoading(false);
                showModal('message-box', 'فشل التحميل', `حدث خطأ أثناء محاولة تحميل البيانات: ${error.message}`);
            }
        }

        // --- Modification Functions ---
        
        // Pre-confirm required for table creation to warn about data loss
        function createNewTablePreconfirm() {
            if (currentData.length > 0) {
                 showModal('create-table-modal');
            } else {
                createNewTable(); // No data, create immediately
            }
        }

        function createNewTable() {
            hideModal('create-table-modal');
            const cols = parseInt(document.getElementById('new-cols').value) || 4;
            const rows = parseInt(document.getElementById('new-rows').value) || 5;

            // Input validation
            if (cols < 1 || rows < 0) {
                 showModal('message-box', 'خطأ في الأبعاد', 'الرجاء إدخال أبعاد صالحة (العمود > 0، السطر >= 0).');
                 return;
            }
            
            const newHeaders = Array.from({ length: cols }, (_, i) => `العنوان ${i + 1}`);
            const newTable = [newHeaders];
            const emptyRow = Array(cols).fill('');

            for (let i = 0; i < rows; i++) {
                newTable.push(emptyRow.slice());
            }

            currentData = newTable;
            originalData = deepClone(currentData);
            fileBuffers = [];
            renderTable();
            showModal('message-box', 'تم إنشاء جدول جديد', `تم إنشاء جدول جديد بأبعاد ${rows} سطر و ${cols} عمود.`);
        }

        function addRow() {
            if (currentData.length === 0) {
                showModal('message-box', 'خطأ في التحرير', 'الرجاء تحميل جدول أو إنشاء جدول جديد أولاً.');
                return;
            }
            const cols = currentData[0].length;
            const newRow = Array(cols).fill('');
            currentData.push(newRow);
            renderTable();
            updateChangeReport();
        }

        /**
         * Filters the table using Array.prototype.filter for performance.
         */
        function filterTable(mode) {
            if (currentData.length <= 1) {
                hideModal(mode === 'delete' ? 'delete-match-modal' : 'keep-match-modal');
                showModal('message-box', 'جدول فارغ', 'لا توجد بيانات للفلترة.');
                return;
            }

            const keywordElement = document.getElementById(mode === 'delete' ? 'delete-keyword' : 'keep-keyword');
            const keyword = keywordElement.value.trim();
            
            if (!keyword) {
                showModal('message-box', 'حقل مطلوب', 'الرجاء إدخال كلمة أو عبارة مفتاحية.');
                return;
            }
            hideModal(mode === 'delete' ? 'delete-match-modal' : 'keep-match-modal');
            toggleLoading(true);

            const keywordLower = keyword.toLowerCase();
            const headers = currentData[0];
            const rowsToFilter = currentData.slice(1);
            let rowsRemoved = 0;

            const filteredRows = rowsToFilter.filter(row => {
                const containsKeyword = row.some(cell => String(cell).toLowerCase().includes(keywordLower));

                if (mode === 'delete') {
                    if (containsKeyword) {
                        rowsRemoved++;
                        return false; // DELETE mode: return false if match (remove row)
                    }
                    return true; // Keep if no match
                } else { // 'keep' mode
                    if (!containsKeyword) {
                        rowsRemoved++;
                        return false; // KEEP mode: return false if no match (remove row)
                    }
                    return true; // Keep if match
                }
            });

            currentData = [headers].concat(filteredRows);
            
            setTimeout(() => {
                renderTable();
                toggleLoading(false);
                showModal('message-box', 'تم تطبيق التصفية', `تم إزالة ${rowsRemoved} سطر. إجمالي السطور المتبقية: ${currentData.length - 1}.`);
            }, 0);
        }

        // Custom confirmation logic
        function clearTablePreconfirm() {
            if (currentData.length === 0) return;
            showModal('message-box', 'تأكيد مسح الجدول', 'هل أنت متأكد من مسح كافة البيانات؟ هذا الإجراء لا يمكن التراجع عنه.');
            
            const messageBox = document.getElementById('message-box');
            const footer = messageBox.querySelector('.mt-6.flex.justify-end');
            footer.innerHTML = `
                <button onclick="hideModal('message-box')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200 rtl:ml-3">
                    إلغاء
                </button>
                <button onclick="performClearTable()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    تأكيد المسح
                </button>
            `;
        }
        
        function performClearTable() {
            hideModal('message-box');
            currentData = [];
            originalData = [];
            fileBuffers = [];
            renderTable();
            showModal('message-box', 'تم مسح الجدول', 'تم مسح جميع البيانات بنجاح.');
        }
        
        // --- Column Management Functions ---

        function showColumnManager() {
            if (currentData.length === 0) {
                showModal('message-box', 'خطأ في الإدارة', 'الرجاء تحميل جدول أو إنشاء جدول جديد أولاً.');
                return;
            }

            const select = document.getElementById('remove-col-select');
            select.innerHTML = '';
            
            currentData[0].forEach((header, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${String(header || `عمود ${index + 1}`).trim()} (العمود ${index + 1})`;
                select.appendChild(option);
            });

            document.getElementById('remove-col-btn').disabled = currentData[0].length === 0;

            showModal('manage-columns-modal');
        }

        function performAddColumn() {
            if (currentData.length === 0) {
                showModal('message-box', 'خطأ في الإدارة', 'الرجاء تحميل جدول أو إنشاء جدول جديد أولاً.');
                return;
            }

            const newColIndex = currentData[0].length + 1;
            currentData[0].push(`عمود جديد ${newColIndex}`);

            for (let i = 1; i < currentData.length; i++) {
                currentData[i].push('');
            }
            
            renderTable();
            showModal('message-box', 'عمود جديد', `تم إضافة عمود جديد بنجاح.`);
            hideModal('manage-columns-modal');
        }

        function performRemoveColumn() {
            const select = document.getElementById('remove-col-select');
            const colIndex = parseInt(select.value);

            if (currentData[0].length <= 1) {
                showModal('message-box', 'خطأ في الحذف', 'يجب أن يحتوي الجدول على عمود واحد على الأقل.');
                return;
            }

            if (colIndex >= 0 && colIndex < currentData[0].length) {
                // Efficiently remove the column across all rows
                currentData.forEach(row => {
                    row.splice(colIndex, 1);
                });
                
                renderTable();
                showModal('message-box', 'تم حذف العمود', `تم حذف العمود ${select.options[select.selectedIndex].text} بنجاح.`);
            }
            hideModal('manage-columns-modal');
        }

        // --- Remove Duplicates Functions ---
        
        function showRemoveDuplicatesModal() {
             if (currentData.length <= 1) {
                showModal('message-box', 'جدول فارغ', 'لا توجد بيانات لإزالة التكرارات منها.');
                return;
            }

            const select = document.getElementById('duplicate-col-select');
            select.innerHTML = '';

            currentData[0].forEach((header, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${String(header || `عمود ${index + 1}`).trim()} (العمود ${index + 1})`;
                select.appendChild(option);
            });

            // Handle radio button toggling
            const columnRadio = document.querySelector('input[name="duplicate-mode"][value="column"]');
            columnRadio.onchange = () => select.disabled = false;
            document.querySelector('input[name="duplicate-mode"][value="all"]').onchange = () => select.disabled = true;
            select.disabled = true;

            showModal('remove-duplicates-modal');
        }

        /**
         * Removes duplicates using a Set for O(N) performance.
         */
        function removeDuplicates() {
            if (currentData.length <= 1) return;
            hideModal('remove-duplicates-modal');
            toggleLoading(true);

            const mode = document.querySelector('input[name="duplicate-mode"]:checked').value;
            const headers = currentData[0];
            const rowsToFilter = currentData.slice(1);
            const uniqueData = [headers];
            const seen = new Set();
            let removedCount = 0;

            let colIndex = -1;
            if (mode === 'column') {
                colIndex = parseInt(document.getElementById('duplicate-col-select').value);
                // Simple validation check
                if (isNaN(colIndex) || colIndex < 0 || colIndex >= headers.length) {
                     toggleLoading(false);
                     showModal('message-box', 'خطأ في العمود', 'الرجاء اختيار عمود صالح للإزالة بناءً عليه.');
                     return;
                }
            }
            
            // Loop through data rows (O(N) operation)
            for (const row of rowsToFilter) {
                let key;

                if (mode === 'all') {
                    // Create a normalized key from all cells
                    key = row.map(cell => String(cell).toLowerCase().trim()).join('|');
                } else if (mode === 'column') {
                    // Create a normalized key from the selected column's cell
                    key = String(row[colIndex]).toLowerCase().trim();
                }

                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueData.push(row);
                } else {
                    removedCount++;
                }
            }

            currentData = uniqueData;
            
            setTimeout(() => {
                renderTable();
                toggleLoading(false);
                showModal('message-box', 'تمت إزالة التكرارات', `تمت إزالة ${removedCount} سطر مكرر. إجمالي السطور المتبقية: ${currentData.length - 1}.`);
            }, 0);
        }


        // --- Download Function ---

        function downloadFile() {
            if (currentData.length === 0) {
                hideModal('download-modal');
                showModal('message-box', 'لا توجد بيانات', 'لا يوجد جدول لتنزيله.');
                return;
            }

            hideModal('download-modal');
            toggleLoading(true);

            const filenameInput = document.getElementById('download-filename').value.trim() || 'جدول_معدل';
            const format = document.querySelector('input[name="file-format"]:checked').value;
            let filename = `${filenameInput}.${format}`;
            let fileContent;
            let mimeType;

            try {
                // Ensure the data array is clean before export
                const exportData = deepClone(currentData);
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                if (format === 'xlsx') {
                    fileContent = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                } else if (format === 'csv') {
                    // Use correct CSV encoding for Arabic/UTF-8
                    fileContent = "\uFEFF" + XLSX.utils.sheet_to_csv(ws, {FS: ',', RS: '\n'});
                    mimeType = 'text/csv;charset=utf-8;';
                } else if (format === 'json') {
                    const jsonArr = XLSX.utils.sheet_to_json(ws);
                    fileContent = JSON.stringify(jsonArr, null, 2);
                    mimeType = 'application/json';
                }

                const blob = new Blob([fileContent], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showModal('message-box', 'تم التنزيل بنجاح', `تم تنزيل الملف بنجاح بصيغة ${format.toUpperCase()}.`);

            } catch (error) {
                console.error("Download error:", error);
                showModal('message-box', 'فشل التنزيل', 'حدث خطأ أثناء إنشاء ملف التنزيل.');
            } finally {
                toggleLoading(false);
            }
        }

        // Initialize table and report on load
        window.onload = () => {
            renderTable();
        };

    </script>
</body>
</html>

